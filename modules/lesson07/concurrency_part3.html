

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Concurrency Part 3: GIL &mdash; PythonCert220 2.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Threading and multiprocessing Part 1: How to" href="ThreadingMultiprocessing_part1.html" />
    <link rel="prev" title="Concurrency Part 2: Other alternatives" href="concurrency_part2.html" /> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> PythonCert220
          

          
          </a>

          
            
            
              <div class="version">
                2.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Lesson content</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../index.html#py220-advanced-python-programming">Py220: Advanced Python Programming</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../lesson00/index.html">Welcome!</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lesson01/index.html">Lesson 1 : Automated Testing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lesson02/index.html">Lesson 2 : Logging &amp; Debuging</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lesson03/index.html">Lesson 3 : Relational databases</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lesson04/index.html">Lesson 4 : Iteration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lesson05/index.html">Lesson 5 : Consuming APIs with NoSQL</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lesson06/index.html">Lesson 6 : Profiling and performance</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html">Lesson 7 : Currency and async</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="prerequisites.html">Lesson 7: Concurrency and Async</a></li>
<li class="toctree-l4"><a class="reference internal" href="introduction.html">Lesson 7 Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="concurrency_part1.html">Concurrency Part 1: Concurrent Programming</a></li>
<li class="toctree-l4"><a class="reference internal" href="concurrency_part2.html">Concurrency Part 2: Other alternatives</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">Concurrency Part 3: GIL</a></li>
<li class="toctree-l4"><a class="reference internal" href="ThreadingMultiprocessing_part1.html">Threading and multiprocessing Part 1: How to</a></li>
<li class="toctree-l4"><a class="reference internal" href="ThreadingMultiprocessing_part2.html">Threading and multiprocessing Part 2: The threading module</a></li>
<li class="toctree-l4"><a class="reference internal" href="ThreadingMultiprocessing_part3.html">Threading and multiprocessing Part 3: Locking Exercise</a></li>
<li class="toctree-l4"><a class="reference internal" href="ThreadingMultiprocessing_part4.html">Threading and multiprocessing Part 4: Managing thread results</a></li>
<li class="toctree-l4"><a class="reference internal" href="ThreadingMultiprocessing_part5.html">Threading and multiprocessing Part 5: Multiprocessing</a></li>
<li class="toctree-l4"><a class="reference internal" href="ThreadingMultiprocessing_part6.html">Threading and multiprocessing Part 6: Pooling</a></li>
<li class="toctree-l4"><a class="reference internal" href="async.html">Lesson 7.2 Async</a></li>
<li class="toctree-l4"><a class="reference internal" href="activity.html">Lesson 7 Activity</a></li>
<li class="toctree-l4"><a class="reference internal" href="assignment.html">Lesson 7 : Assignment</a></li>
<li class="toctree-l4"><a class="reference internal" href="office_hours_recaps.html">Office Hours : Recaps</a></li>
<li class="toctree-l4"><a class="reference internal" href="office_hours_all.html">Office Hours : This weeks’ content</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../lesson08/index.html">Lesson 8 : Functional Techniques</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lesson09/index.html">Lesson 9 : Advanced Python language constructs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lesson10/index.html">Lesson 10 : Metaprogramming</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../quiz/index.html">Quizzes</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../references/index.html">External links</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quiz/index.html">Quizzes</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">PythonCert220</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Lesson content</a> &raquo;</li>
        
          <li><a href="index.html">Lesson 7 : Currency and async</a> &raquo;</li>
        
      <li>Concurrency Part 3: GIL</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/modules/lesson07/concurrency_part3.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="concurrency-part-3-gil">
<h1>Concurrency Part 3: GIL<a class="headerlink" href="#concurrency-part-3-gil" title="Permalink to this headline">¶</a></h1>
<p><strong>Global Interpreter Lock</strong></p>
<p>(<strong>GIL</strong>)</p>
<p>This is a lock which must be obtained by each thread before it can
execute, ensuring thread safety</p>
<a class="reference internal image-reference" href="_static/gil.png"><img alt="_static/gil.png" src="_static/gil.png" style="width: 100.0%;" /></a>
<p>The GIL is released during IO operations, so threads which spend time
waiting on network or disk access can enjoy performance gains</p>
<p>The GIL is not unlike multitasking in humans, some things can truly be
done in parallel, others have to be done by time slicing.</p>
<p>Note that potentially blocking or long-running operations, such as I/O, image processing, and NumPy number crunching, happen outside the GIL. Therefore it is only in multithreaded programs that spend a lot of time inside the GIL, interpreting CPython bytecode, that the GIL becomes a bottleneck. But: it can still cause performance degradation.</p>
<p>Not only will threads not help cpu-bound problems, they can actually make things <em>worse</em>, especially on multi-core machines!</p>
<p>Python threads do not work well for computationally intensive work.</p>
<p>Python threads work well if the threads are spending time waiting for something:</p>
<blockquote>
<div><ul class="simple">
<li>Database Access.</li>
<li>Network Access.</li>
<li>File I/O.</li>
</ul>
</div></blockquote>
<p>Some alternative Python implementations such as Jython and IronPython
have no GIL.</p>
<p>cPython and PyPy have one.</p>
<p>More about the gil</p>
<p>More on the GIL:</p>
<p><a class="reference external" href="https://emptysqua.re/blog/grok-the-gil-fast-thread-safe-python/">https://emptysqua.re/blog/grok-the-gil-fast-thread-safe-python/</a></p>
<p>If you really want to understand the GIL – and get blown away – watch this one:</p>
<p><a class="reference external" href="http://pyvideo.org/pycon-us-2010/pycon-2010--understanding-the-python-gil---82.html">http://pyvideo.org/pycon-us-2010/pycon-2010–understanding-the-python-gil—82.html</a></p>
<ul class="simple">
<li><a class="reference external" href="http://wiki.python.org/moin/GlobalInterpreterLock">http://wiki.python.org/moin/GlobalInterpreterLock</a></li>
<li><a class="reference external" href="https://docs.python.org/3/c-api/init.html#threads">https://docs.python.org/3/c-api/init.html#threads</a></li>
<li><a class="reference external" href="http://hg.python.org/cpython/file/05e8dde3229c/Python/pystate.c#l761">http://hg.python.org/cpython/file/05e8dde3229c/Python/pystate.c#l761</a></li>
</ul>
<p><strong>NOTE:</strong> The GIL <em>seems</em> like such an obvious limitation that you have to wonder why it’s there. Indeed, there have been multiple efforts to remove it. But it turns out that Python’s design makes that very hard (maybe even impossible) without severely reducing performance on single threaded programs.</p>
<p>The current “Best” effort is Larry Hastings’ <a class="reference external" href="https://speakerdeck.com/pycon2017/larry-hastings-the-gilectomy-hows-it-going">gilectomy</a></p>
<p>But that may be stalled out at this point, too. No one should count on it going away in cPython.</p>
<div class="section" id="posted-without-comment">
<h2>Posted without comment<a class="headerlink" href="#posted-without-comment" title="Permalink to this headline">¶</a></h2>
<div class="figure">
<img alt="_static/killGIL.jpg" class="fill" src="_static/killGIL.jpg" />
</div>
</div>
<div class="section" id="advantages-disadvantages-of-processes">
<h2>Advantages / Disadvantages of Processes<a class="headerlink" href="#advantages-disadvantages-of-processes" title="Permalink to this headline">¶</a></h2>
<p>Processes are heavier weight – each process makes a copy of the entire interpreter (mostly…) – uses more resources.</p>
<p>You need to copy the data you need back and forth between processes.</p>
<p>Slower to start, slower to use, more memory.</p>
<p>But as the entire python process is copied, each subprocess is working with the different objects – they can’t step on each other. So there is:</p>
<blockquote>
<div><strong>no GIL</strong></div></blockquote>
<p>Multiprocessing is suitable for computationally intensive work.</p>
<p>Works best for “large” problems with not much data to pass back and forth, as that’s what’s expensive.</p>
<p>Note that there are ways to share memory between processes, if you have a lot of read-only data that needs to be used. (see <a class="reference external" href="https://docs.python.org/3/library/mmap.html">Memory Maps</a>)</p>
<p>Synchronization options:</p>
<blockquote>
<div><ul class="simple">
<li>Locks (Mutex: mutual exclusion, Rlock: reentrant lock).</li>
<li>Semaphore.</li>
<li>BoundedSemaphore.</li>
<li>Event.</li>
<li>Condition.</li>
<li>Queues.</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="mutex-locks-threading-lock">
<h2>Mutex locks (<code class="docutils literal notranslate"><span class="pre">threading.Lock</span></code>)<a class="headerlink" href="#mutex-locks-threading-lock" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><ul class="simple">
<li>Probably most common.</li>
<li>Only one thread can modify shared data at any given time.</li>
<li>Thread determines when unlocked.</li>
<li>Must put lock/unlock around critical code in ALL threads.</li>
<li>Difficult to manage.</li>
</ul>
</div></blockquote>
<p>Easiest with context manager:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">x_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>

<span class="c1"># Example critical section</span>
<span class="k">with</span> <span class="n">x_lock</span><span class="p">:</span>
    <span class="c1"># statements using x</span>
</pre></div>
</div>
<p>Only one lock per thread! (or risk mysterious deadlocks).</p>
<p>Or use RLock for code-based locking (locking function/method execution rather than data access).</p>
</div>
<div class="section" id="subprocesses-subprocess">
<h2>Subprocesses (<code class="docutils literal notranslate"><span class="pre">subprocess</span></code>)<a class="headerlink" href="#subprocesses-subprocess" title="Permalink to this headline">¶</a></h2>
<p>Subprocesses are completely separate processes invoked from a master process (your python program).</p>
<p>Usually used to call non-python programs (shell commands). But of course, a Python program can be a command line program as well, so you can call either your or other python programs this way.</p>
<p>Easy invocation:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">subprocess</span>

<span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;ls&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The program halts while waiting for the subprocess to finish. (unless you call it from a thread!)</p>
<p>You can control communication with the subprocess via:</p>
<p><code class="docutils literal notranslate"><span class="pre">stdout</span></code>, <code class="docutils literal notranslate"><span class="pre">stdin</span></code>, <code class="docutils literal notranslate"><span class="pre">stderr</span></code> with:</p>
<p><code class="docutils literal notranslate"><span class="pre">subprocess.Popen</span></code></p>
<p>Lots of options there!</p>
<div class="section" id="pipes-and-pickle-and-subprocess">
<h3>Pipes and <code class="docutils literal notranslate"><span class="pre">pickle</span></code> and <code class="docutils literal notranslate"><span class="pre">subprocess</span></code><a class="headerlink" href="#pipes-and-pickle-and-subprocess" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><ul class="simple">
<li>Very low level, for the brave of heart.</li>
<li>Can send just about any Python object.</li>
</ul>
</div></blockquote>
<p>For this to work, you need to send messages, as each process runs its own independent Python interpreter.</p>
<div class="section" id="when-to-use-what">
<h4>When to Use What<a class="headerlink" href="#when-to-use-what" title="Permalink to this headline">¶</a></h4>
<img alt="_static/proc_thread_async.png" src="_static/proc_thread_async.png" />
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="ThreadingMultiprocessing_part1.html" class="btn btn-neutral float-right" title="Threading and multiprocessing Part 1: How to" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="concurrency_part2.html" class="btn btn-neutral" title="Concurrency Part 2: Other alternatives" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, University of Washington, Christopher Barker, Luis Diego Conejo, Andy Miles, Rick Riehle, Joseph Schilz. Creative Commons Attribution-ShareAlike 3.0 license

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

  

  <script type="text/javascript" src="../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>